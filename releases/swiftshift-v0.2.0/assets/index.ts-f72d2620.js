import{S as x,T as S}from"./telegram-791c4748.js";import{L as w,R}from"./logService-ad1c7ab9.js";const E={async fetchMetadata(i){var n;try{if(!i.startsWith("http"))return null;const r=new AbortController,a=setTimeout(()=>r.abort(),3e3),s=await fetch(i,{signal:r.signal});clearTimeout(a);const p=await s.text(),d=m=>{const u=new RegExp(`<meta[^>]+(?:property|name)=["'](?:og:|twitter:)?${m}["'][^>]+content=["']([^"']+)["']`,"i"),t=p.match(u);if(t)return t[1];const l=new RegExp(`<meta[^>]+content=["']([^"']+)["'][^>]+(?:property|name)=["'](?:og:|twitter:)?${m}["']`,"i"),h=p.match(l);return h?h[1]:null},e=d("title")||((n=p.match(/<title>([^<]+)<\/title>/i))==null?void 0:n[1]),c=d("description"),g=d("image"),o=d("site_name");return!e&&!c&&!g?null:{title:e==null?void 0:e.trim(),description:c==null?void 0:c.trim(),image:g,siteName:o==null?void 0:o.trim()}}catch{return null}}},k={async init(){await w.add({type:"info",message:"Rebuilding context menus..."}),chrome.contextMenus.removeAll(async()=>{const i=[{id:"swiftshift-text",title:"Send Text to Telegram",contexts:["selection"]},{id:"swiftshift-link",title:"Send Link to Telegram",contexts:["link"]},{id:"swiftshift-image",title:"Send Image to Telegram",contexts:["image"]},{id:"swiftshift-video",title:"Send Video to Telegram",contexts:["video"]},{id:"swiftshift-audio",title:"Send Audio to Telegram",contexts:["audio"]},{id:"swiftshift-page",title:"Send Page to Telegram",contexts:["page"]},{id:"swiftshift-capture",title:"ðŸ“· Capture Page to Telegram",contexts:["page"]}];i.forEach(a=>{chrome.contextMenus.create({id:a.id,title:a.title,contexts:a.contexts,documentUrlPatterns:["http://*/*","https://*/*"]})});const n=await x.getActiveProfile();if(!n||!n.botToken){this.createSetupPlaceholder(i.map(a=>a.id));return}const r=i.map(a=>a.id);if(n.targets.length>0){const a=n.targets.filter(e=>e.type!=="topic"),s=n.targets.filter(e=>e.type==="topic"),{recentTargets:p}=await chrome.storage.local.get("recentTargets"),d=p||[];r.forEach(e=>{const c=e==="swiftshift-image",g=e==="swiftshift-capture";a.forEach(t=>{const l=s.filter(h=>h.parentId===t.id);if(l.length>0){chrome.contextMenus.create({id:`${e}-parent-${t.id}`,parentId:e,title:`ðŸ“ ${t.name}`,contexts:["all"]}),c?(chrome.contextMenus.create({id:`${e}-send-parent-${t.id}`,parentId:`${e}-parent-${t.id}`,title:`ðŸ“¤ Send to ${t.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-photo`,parentId:`${e}-send-parent-${t.id}`,title:"ðŸ–¼ï¸ Send Compressed",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-file`,parentId:`${e}-send-parent-${t.id}`,title:"ðŸ“„ Send Uncompressed",contexts:["all"]})):g?(chrome.contextMenus.create({id:`${e}-send-parent-${t.id}`,parentId:`${e}-parent-${t.id}`,title:`ðŸ“¤ Capture to ${t.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-photo`,parentId:`${e}-send-parent-${t.id}`,title:"ðŸ–¼ï¸ Compressed (Photo)",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-file`,parentId:`${e}-send-parent-${t.id}`,title:"ðŸ“„ Uncompressed (File)",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-sep-region-${t.id}`,parentId:`${e}-send-parent-${t.id}`,type:"separator",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-region`,parentId:`${e}-send-parent-${t.id}`,title:"âœ‚ï¸ Select Region...",contexts:["all"]})):chrome.contextMenus.create({id:`${e}-target-${t.id}`,parentId:`${e}-parent-${t.id}`,title:`ðŸ“¤ Send directly to ${t.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-sep-${t.id}`,parentId:`${e}-parent-${t.id}`,type:"separator",contexts:["all"]});const h=[...l].sort(($,y)=>{if($.pinned&&!y.pinned)return-1;if(!$.pinned&&y.pinned)return 1;const M=d.indexOf($.id),C=d.indexOf(y.id);return M!==-1&&C===-1?-1:M===-1&&C!==-1?1:M!==-1&&C!==-1?M-C:0}),f=5,T=h.slice(0,f),U=h.slice(f).sort(($,y)=>$.name.localeCompare(y.name)),v=($,y)=>{c||g?(chrome.contextMenus.create({id:`${e}-topic-menu-${$.id}`,parentId:y,title:`# ${$.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${$.id}-photo`,parentId:`${e}-topic-menu-${$.id}`,title:g?"ðŸ–¼ï¸ Compressed (Photo)":"ðŸ–¼ï¸ Send Compressed",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${$.id}-file`,parentId:`${e}-topic-menu-${$.id}`,title:g?"ðŸ“„ Uncompressed (File)":"ðŸ“„ Send Uncompressed",contexts:["all"]}),g&&(chrome.contextMenus.create({id:`${e}-sep-region-${$.id}`,parentId:`${e}-topic-menu-${$.id}`,type:"separator",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${$.id}-region`,parentId:`${e}-topic-menu-${$.id}`,title:"âœ‚ï¸ Select Region...",contexts:["all"]}))):chrome.contextMenus.create({id:`${e}-target-${$.id}`,parentId:y,title:`# ${$.name}`,contexts:["all"]})};T.forEach($=>{v($,`${e}-parent-${t.id}`)}),U.length>0&&(chrome.contextMenus.create({id:`${e}-sep-more-${t.id}`,parentId:`${e}-parent-${t.id}`,type:"separator",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-more-${t.id}`,parentId:`${e}-parent-${t.id}`,title:`ðŸ“‚ More Topics... (${U.length})`,contexts:["all"]}),U.forEach($=>{v($,`${e}-more-${t.id}`)}))}else c?(chrome.contextMenus.create({id:`${e}-menu-${t.id}`,parentId:e,title:t.type==="private"?`ðŸ‘¤ ${t.name}`:`ðŸ“¤ ${t.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-photo`,parentId:`${e}-menu-${t.id}`,title:"ðŸ–¼ï¸ Send Compressed",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-file`,parentId:`${e}-menu-${t.id}`,title:"ðŸ“„ Send Uncompressed",contexts:["all"]})):chrome.contextMenus.create({id:`${e}-target-${t.id}`,parentId:e,title:t.type==="private"?`ðŸ‘¤ ${t.name}`:`ðŸ“¤ ${t.name}`,contexts:["all"]})});const o=s.filter(t=>!a.some(l=>t.parentId===l.id));o.length>0&&o.forEach(t=>{c?(chrome.contextMenus.create({id:`${e}-orphan-menu-${t.id}`,parentId:e,title:`# ${t.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-photo`,parentId:`${e}-orphan-menu-${t.id}`,title:"ðŸ–¼ï¸ Send Compressed",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-target-${t.id}-file`,parentId:`${e}-orphan-menu-${t.id}`,title:"ðŸ“„ Send Uncompressed",contexts:["all"]})):chrome.contextMenus.create({id:`${e}-target-${t.id}`,parentId:e,title:`# ${t.name}`,contexts:["all"]})});const m=d[0],u=m?n.targets.find(t=>t.id===m):null;u&&(chrome.contextMenus.create({id:`${e}-sep-quick`,parentId:e,type:"separator",contexts:["all"]}),c?(chrome.contextMenus.create({id:`${e}-quick-menu-${u.id}`,parentId:e,title:`âš¡ Quick: ${u.name}`,contexts:["all"]}),chrome.contextMenus.create({id:`${e}-quick-target-${u.id}-photo`,parentId:`${e}-quick-menu-${u.id}`,title:"ðŸ–¼ï¸ Send Compressed",contexts:["all"]}),chrome.contextMenus.create({id:`${e}-quick-target-${u.id}-file`,parentId:`${e}-quick-menu-${u.id}`,title:"ðŸ“„ Send Uncompressed",contexts:["all"]})):chrome.contextMenus.create({id:`${e}-quick-target-${u.id}`,parentId:e,title:`âš¡ Sent last to: ${u.name}`,contexts:["all"]}))})}else r.forEach(a=>{chrome.contextMenus.create({id:`${a}-setup-inbox`,parentId:a,title:`âœ‰ï¸ Shift to Bot Inbox (${n.name})`,contexts:["all"]}),chrome.contextMenus.create({id:`${a}-setup-guide`,parentId:`${a}-setup-inbox`,title:"Help: Message your bot first!",enabled:!1,contexts:["all"]})});r.forEach(a=>{chrome.contextMenus.create({id:`${a}-separator-add`,parentId:a,type:"separator",contexts:["all"],documentUrlPatterns:["https://web.telegram.org/*"]}),chrome.contextMenus.create({id:`${a}-add-destination`,parentId:a,title:"âž• Add to SwiftShift",contexts:["all"],documentUrlPatterns:["https://web.telegram.org/*"]})}),await w.add({type:"success",message:`Menu built with ${n.targets.length} targets`,details:`Profile: ${n.name}`})})},createSetupPlaceholder(i){i.forEach(n=>{chrome.contextMenus.create({id:`${n}-setup-required`,parentId:n,title:"âš ï¸ Setup Required (Click Extension Icon)",enabled:!1,contexts:["all"]})})},async onClicked(i,n){const r=i.menuItemId.toString();if(r.endsWith("-add-destination")){await this.handleAddDestination(n);return}if(r.endsWith("-setup-inbox")){const t=await x.getActiveProfile();if(t){const l=t.name.replace(/\s+/g,"");chrome.tabs.create({url:`https://t.me/${l}`})}return}if(r.includes("swiftshift-capture-target-")){const t=r.match(/swiftshift-capture-target-(.+?)-(photo|file|region)$/);if(t&&(n!=null&&n.id)){const l=t[1],h=t[2];await this.handleCaptureAndSend(l,n,h)}return}const a=r.match(/-target-(.+?)(?:-(photo|file))?$/);if(!a)return;const s=a[1],p=a[2],d=r.match(/swiftshift-(.+?)-target/),e=d?d[1]:void 0,c=await this.buildPayload(i,n,e,p==="file");if(!c)return;const g=await x.getActiveProfile();if(!g)return;const o=g.targets.find(t=>t.id===s),m={chatId:s.includes(":")?s.split(":")[0]:s,threadId:o==null?void 0:o.threadId,...c},u=p==="file"&&c.document?await S.sendDocument(g.botToken,m):await S.sendPayloadSmart(g.botToken,m);if(chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:u.success?"Sent Successfully":"Failed to Send",message:u.success?`Sent to ${(o==null?void 0:o.name)||"Telegram"}`:u.error}),await w.add({type:u.success?"success":"error",message:u.success?`Sent to ${(o==null?void 0:o.name)||"Unknown"}`:`Failed: ${u.error}`,targetName:o==null?void 0:o.name,details:`MenuID: ${r}, Mode: ${p||"auto"}`}),u.success){let t="",l="text",h;if(m.text){const f=/^(http|mailto|tel|magnet|ftp|tg):/i.test(m.text),T=!m.text.includes(`
`),U=m.text.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);m.latitude!==void 0||!!U?(l="location",t=m.text):f&&T?(l="link",t=m.text,m.text.startsWith("http")&&(h=await E.fetchMetadata(t)||void 0)):(l="text",t=m.text)}else if(m.audio)l="audio",t=m.audio;else if(m.photo||m.document){const f=m.photo||m.document;t=f,e==="image"||f.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp)/i)||f.startsWith("data:image/")?l="image":l="file",typeof t!="string"&&(t="Binary Content")}await R.add({type:l,content:t,preview:l==="image"?t:t.length>100?t.slice(0,100)+"...":t,targetName:(o==null?void 0:o.name)||"Unknown",targetId:s,threadId:o==null?void 0:o.threadId,metadata:h})}await x.addRecentTarget(s),this.init()},async buildPayload(i,n,r,a){if(r==="image"&&i.mediaType==="image"&&i.srcUrl){const s=i.srcUrl.toLowerCase().endsWith(".svg")||i.srcUrl.toLowerCase().includes(".svg?")||i.srcUrl.startsWith("data:image/svg+xml");return a||s?{document:i.srcUrl,caption:n==null?void 0:n.url}:{photo:i.srcUrl,caption:n==null?void 0:n.url}}if(r==="link"&&i.linkUrl)return{text:i.linkUrl};if(r==="audio"&&i.mediaType==="audio"&&i.srcUrl)return{audio:i.srcUrl,caption:n==null?void 0:n.url};if(r==="text"&&i.selectionText)return{text:i.selectionText};if(i.selectionText)return{text:i.selectionText};if(i.linkUrl)return{text:i.linkUrl};if(i.mediaType==="image"&&i.srcUrl){const s=i.srcUrl.toLowerCase().endsWith(".svg")||i.srcUrl.toLowerCase().includes(".svg?")||i.srcUrl.startsWith("data:image/svg+xml");return a||s?{document:i.srcUrl,caption:n==null?void 0:n.url}:{photo:i.srcUrl,caption:n==null?void 0:n.url}}return i.mediaType==="video"&&i.srcUrl?{text:`Video: ${i.srcUrl}
Source: ${n==null?void 0:n.url}`}:i.mediaType==="audio"&&i.srcUrl?{audio:i.srcUrl,caption:n==null?void 0:n.url}:n!=null&&n.url?{text:`${n.title||"Page"}
${n.url}`}:null},async handleAddDestination(i){var u;if(!(i!=null&&i.url)||!i.id){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Error",message:"Could not detect current page."});return}const n=await x.getActiveProfile();if(!n){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Setup Required",message:"Please connect your bot first."});return}const a=(i.url.split("#")[1]||"").match(/(-?\d+)(?:_(\d+))?/);if(!a){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Error",message:"Could not detect Chat ID from URL."});return}const s=a[1],p=a[2]?parseInt(a[2]):void 0,d=p?`${s}:${p}`:s;if(n.targets.some(t=>{if(t.id===d)return!0;const l=t.id.replace("-100",""),h=d.replace("-100","");return l===h})){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Already Exists",message:"This chat is already in your destinations."});return}let c=(i.title||"Unknown Chat").replace(/\s*-\s*Telegram$/,"").trim(),g="";if(p&&(c.includes(" â€º ")||c.includes(" > "))){const t=c.split(/ [â€º>] /);g=t[0].trim(),c=t[t.length-1].trim()}let o="private";p?o="topic":s.startsWith("-")&&(o="channel");let m=[...n.targets];if(p&&!n.targets.some(l=>{const h=l.id.replace("-100",""),f=s.replace("-100","");return h===f&&l.type!=="topic"})){let l=g||`Channel ${s.replace("-100","").slice(-6)}`;try{const h=await S.getChat(n.botToken,s);h.ok&&((u=h.result)!=null&&u.title)&&(l=h.result.title)}catch{}m.push({id:s,name:l,type:"channel",username:""})}m.push({id:d,name:c,type:o,username:"",threadId:p,parentId:p?s:void 0}),await x.updateProfileTargets(n.id,m),await w.add({type:"success",message:`Target Added: ${c}`,details:`Type: ${o}, ID: ${d}`}),chrome.runtime.sendMessage({type:"REFRESH_MENU"}),this.init(),chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Added to SwiftShift!",message:`${c} is now in your destinations.`})},async handleCaptureAndSend(i,n,r="file"){var p,d;const a=await x.getActiveProfile();if(!a){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Error",message:"Bot baÄŸlantÄ±sÄ± bulunamadÄ±."});return}const s=a.targets.find(e=>e.id===i);if(r==="region"&&n.id){try{chrome.tabs.sendMessage(n.id,{type:"START_REGION_CAPTURE",targetId:i,threadId:s==null?void 0:s.threadId,targetName:s==null?void 0:s.name})}catch{chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Region Capture Error",message:"Bu sayfada bÃ¶lge seÃ§imi yapÄ±lamÄ±yor."})}return}try{const e=await chrome.tabs.captureVisibleTab(n.windowId,{format:"png"}),g=await(await fetch(e)).blob(),m=`capture_${new Date().toISOString().replace(/[:.]/g,"-").slice(0,19)}.png`;let u;const t={chatId:i.includes(":")?i.split(":")[0]:i,threadId:s==null?void 0:s.threadId,caption:`ðŸ“· ${n.title||"Page Capture"}
${n.url}`};if(r==="photo"?u=await S.sendPhoto(a.botToken,{...t,photo:new File([g],m,{type:"image/png"})}):u=await S.sendDocument(a.botToken,{...t,document:new File([g],m,{type:"image/png"})}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:u.success?"Capture Sent!":"Capture Failed",message:u.success?`Sent to ${(s==null?void 0:s.name)||"Telegram"} (${r==="photo"?"Compressed":"Uncompressed"})`:u.error}),await w.add({type:u.success?"success":"error",message:u.success?`Page captured and sent to ${s==null?void 0:s.name}`:`Capture failed: ${u.error}`,targetName:s==null?void 0:s.name,details:`URL: ${n.url}, Mode: ${r}`}),u.success){const l=r==="photo";await R.add({type:l?"image":"file",content:e,preview:l?`ðŸ“· Capture: ${((p=n.title)==null?void 0:p.slice(0,50))||"Unknown"}`:`ðŸ“„ Uncompressed: ${((d=n.title)==null?void 0:d.slice(0,50))||"Unknown"}`,targetName:(s==null?void 0:s.name)||"Unknown",targetId:i,threadId:s==null?void 0:s.threadId}),await x.addRecentTarget(i)}}catch(e){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Capture Error",message:"Sayfa yakalanamadÄ±. Chrome:// veya kÄ±sÄ±tlÄ± sayfalarda Ã§alÄ±ÅŸmaz."}),await w.add({type:"error",message:"Page capture failed",details:String(e)})}}};chrome.runtime.onInstalled.addListener(async i=>{await x.init(),await k.init(),await w.add({type:"info",message:`System: Extension ${i.reason}`,details:`Reason: ${i.reason}`}),i.reason==="install"&&chrome.tabs.create({url:"welcome.html"})});chrome.runtime.onStartup.addListener(async()=>{await k.init(),await w.add({type:"info",message:"System: Browser startup initialization"})});chrome.contextMenus.onClicked.addListener((i,n)=>{k.onClicked(i,n)});chrome.runtime.onMessage.addListener((i,n,r)=>{if(i.type==="REFRESH_MENU")return k.init().then(()=>{r({success:!0})}),!0;if(i.type==="REGION_CAPTURE_SELECTED")return P(i,n.tab).then(()=>{r({success:!0})}),!0});async function P(i,n){if(!(n!=null&&n.windowId))return;const r=await x.getActiveProfile();if(!r)return;const{targetId:a,threadId:s,targetName:p,region:d,devicePixelRatio:e,pageTitle:c,pageUrl:g}=i;try{const o=await chrome.tabs.captureVisibleTab(n.windowId,{format:"png"}),m=await A(o,d,e),t=`region_${new Date().toISOString().replace(/[:.]/g,"-").slice(0,19)}.png`,l=await S.sendDocument(r.botToken,{chatId:a.includes(":")?a.split(":")[0]:a,threadId:s,document:new File([m],t,{type:"image/png"}),caption:`âœ‚ï¸ Region Capture
${c}
${g}`});if(chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:l.success?"Region Sent!":"Region Failed",message:l.success?`Sent to ${p||"Telegram"}`:l.error}),l.success){const h=new FileReader;h.onloadend=async()=>{const f=h.result;await R.add({type:"file",content:f,preview:`âœ‚ï¸ Region: ${(c==null?void 0:c.slice(0,50))||"Selection"}`,targetName:p||"Unknown",targetId:a,threadId:s}),await x.addRecentTarget(a)},h.readAsDataURL(m)}await w.add({type:l.success?"success":"error",message:l.success?`Region captured and sent to ${p}`:`Region capture failed: ${l.error}`,targetName:p,details:`Region: ${d.width}x${d.height}`})}catch{chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Region Capture Error",message:"BÃ¶lge yakalanamadÄ±."})}}async function A(i,n,r){const s=await(await fetch(i)).blob(),p=await createImageBitmap(s),d={left:Math.round(n.left*r),top:Math.round(n.top*r),width:Math.round(n.width*r),height:Math.round(n.height*r)},e=new OffscreenCanvas(d.width,d.height),c=e.getContext("2d");if(!c)throw new Error("Canvas context not available");return c.drawImage(p,d.left,d.top,d.width,d.height,0,0,d.width,d.height),await e.convertToBlob({type:"image/png"})}chrome.commands.onCommand.addListener(async i=>{var n;if(i==="quick_send"){const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(r!=null&&r.id))return;const a=r.id;try{const s=await chrome.tabs.sendMessage(a,{type:"CAPTURE_CONTENT"});if(!s||!s.text)return;const p=await x.getActiveProfile();if(!p)return;const{recentTargets:d}=await chrome.storage.local.get("recentTargets"),e=d&&d.length>0?d[0]:(n=p.targets[0])==null?void 0:n.id;if(!e)return;const c=p.targets.find(m=>m.id===e),g={chatId:e.includes(":")?e.split(":")[0]:e,threadId:c==null?void 0:c.threadId,text:s.text};await w.add({type:"info",message:"Quick Send Triggered (Alt+Q)",details:`Target: ${(c==null?void 0:c.name)||"Unknown"}`});const o=await S.sendPayloadSmart(p.botToken,g);await w.add({type:o.success?"success":"error",message:o.success?`Quick Sent: ${s.text.slice(0,30)}...`:`Quick Send Failed: ${o.error}`,targetName:c==null?void 0:c.name,details:"Alt+Q Command"}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:o.success?"Sent Successfully":"Failed to Send",message:o.success?`Sent to ${(c==null?void 0:c.name)||"Telegram"}`:o.error||"Unknown error"})}catch{}}});
