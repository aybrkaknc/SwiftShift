const c={async init(){await this.migrateFromLegacy(),(await chrome.storage.local.get(["profiles","activeProfileId","recentTargets"])).profiles||await chrome.storage.local.set({profiles:{},activeProfileId:"",recentTargets:[]})},async migrateFromLegacy(){const t=await chrome.storage.local.get(["botToken","chatId","targets","displayName","profiles"]);if(t.botToken&&!t.profiles){const e={id:t.chatId||"legacy-default",name:"Migrated Bot",displayName:t.displayName||"Legacy User",botToken:t.botToken,chatId:t.chatId||"",targets:t.targets||[],lastSynced:Date.now()};await chrome.storage.local.set({profiles:{[e.id]:e},activeProfileId:e.id,recentTargets:t.targets?t.targets.map(s=>s.id).slice(0,3):[]}),await chrome.storage.local.remove(["botToken","chatId","targets","displayName"])}},async saveProfile(t){const{profiles:e}=await chrome.storage.local.get("profiles"),s={...e,[t.id]:t},{activeProfileId:r}=await chrome.storage.local.get("activeProfileId"),i=r||t.id;await chrome.storage.local.set({profiles:s,activeProfileId:i})},async getActiveProfile(){const{activeProfileId:t,profiles:e}=await chrome.storage.local.get(["activeProfileId","profiles"]);return!t||!e?null:e[t]||null},async getAllProfiles(){const{profiles:t}=await chrome.storage.local.get("profiles");return t?Object.values(t):[]},async setActiveProfile(t){const{profiles:e}=await chrome.storage.local.get("profiles");e&&e[t]&&await chrome.storage.local.set({activeProfileId:t})},async updateProfileTargets(t,e){const{profiles:s}=await chrome.storage.local.get("profiles");s&&s[t]&&(s[t].targets=e,s[t].lastSynced=Date.now(),await chrome.storage.local.set({profiles:s}))},async addRecentTarget(t){const{recentTargets:e}=await chrome.storage.local.get("recentTargets");let s=[t,...e||[]];s=[...new Set(s)],s.length>10&&(s=s.slice(0,10)),await chrome.storage.local.set({recentTargets:s})},async clear(){await chrome.storage.local.clear()},async getViewMode(){const{viewMode:t}=await chrome.storage.local.get("viewMode");return t||"bento"},async setViewMode(t){await chrome.storage.local.set({viewMode:t})},async getTheme(){const{theme:t}=await chrome.storage.local.get("theme");return t||"dark"},async setTheme(t){await chrome.storage.local.set({theme:t})}},d={baseUrl:"https://api.telegram.org/bot",getExtensionFromBlob(t){const e=t.type;return e.includes("svg")?"svg":e.includes("png")?"png":e.includes("jpeg")||e.includes("jpg")?"jpg":e.includes("gif")?"gif":e.includes("webp")?"webp":e.includes("mpeg")||e.includes("mp3")?"mp3":e.includes("ogg")?"ogg":e.includes("wav")?"wav":"file"},async getMe(t){try{return await(await fetch(`${this.baseUrl}${t}/getMe`)).json()}catch{return{ok:!1}}},async getChat(t,e){try{return await(await fetch(`${this.baseUrl}${t}/getChat?chat_id=${e}`)).json()}catch{return{ok:!1}}},async sendMessage(t,e){if(!e.text)return{success:!1,error:"Empty text"};const s=4096;if(e.text.length<=s){const n={chat_id:e.chatId,text:e.text,parse_mode:"HTML",link_preview_options:JSON.stringify({is_disabled:!1})};return e.threadId&&(n.message_thread_id=e.threadId),this.makeRequest(t,"sendMessage",n)}const r=[];let i=e.text;for(;i.length>0;)r.push(i.slice(0,s)),i=i.slice(s);let a={success:!1,error:"Unknown"};for(let n=0;n<r.length;n++){const o={chat_id:e.chatId,text:r[n],parse_mode:"HTML",link_preview_options:JSON.stringify({is_disabled:n!==0})};if(e.threadId&&(o.message_thread_id=e.threadId),a=await this.makeRequest(t,"sendMessage",o),!a.success)break}return a},async sendPhoto(t,e){const s=new FormData;s.append("chat_id",e.chatId),e.caption&&s.append("caption",e.caption),e.threadId&&s.append("message_thread_id",e.threadId.toString());let r=e.photo;if(typeof r=="string"&&r.startsWith("data:"))try{r=await(await fetch(r)).blob()}catch{return{success:!1,error:"Data-URI işlenirken hata oluştu"}}if(r instanceof Blob){const n=this.getExtensionFromBlob(r);s.append("photo",r,`image.${n}`)}else if(typeof r=="string")s.append("photo",r);else return{success:!1,error:"Invalid photo format"};const i=await fetch(`${this.baseUrl}${t}/sendPhoto`,{method:"POST",body:s}),a=await i.json();return!i.ok||!a.ok?i.status===413||a.description&&a.description.includes("too large")?{success:!1,error:"Entity Too Large",code:413}:{success:!1,error:this.translateError(a.description||"Unknown Error"),code:a.error_code}:{success:!0,messageId:a.result.message_id}},async sendDocument(t,e){const s=new FormData;s.append("chat_id",e.chatId),e.caption&&s.append("caption",e.caption),e.threadId&&s.append("message_thread_id",e.threadId.toString());let r=e.document;if(typeof r=="string"&&r.startsWith("data:"))try{r=await(await fetch(r)).blob()}catch{return{success:!1,error:"Data-URI işlenirken hata oluştu"}}if(r instanceof Blob){const n=this.getExtensionFromBlob(r);s.append("document",r,`file.${n}`)}else if(typeof r=="string")s.append("document",r);else return{success:!1,error:"Invalid document format"};const i=await fetch(`${this.baseUrl}${t}/sendDocument`,{method:"POST",body:s}),a=await i.json();return!i.ok||!a.ok?{success:!1,error:this.translateError(a.description||"Unknown Error"),code:a.error_code}:{success:!0,messageId:a.result.message_id}},async sendAnimation(t,e){const s=new FormData;s.append("chat_id",e.chatId),e.caption&&s.append("caption",e.caption),e.threadId&&s.append("message_thread_id",e.threadId.toString());let r=e.animation||e.photo;if(typeof r=="string"&&r.startsWith("data:"))try{r=await(await fetch(r)).blob()}catch{return{success:!1,error:"Data-URI işlenirken hata oluştu"}}if(r instanceof Blob){const n=this.getExtensionFromBlob(r);s.append("animation",r,`animation.${n}`)}else if(typeof r=="string")s.append("animation",r);else return{success:!1,error:"Invalid animation format"};const i=await fetch(`${this.baseUrl}${t}/sendAnimation`,{method:"POST",body:s}),a=await i.json();return!i.ok||!a.ok?{success:!1,error:this.translateError(a.description||"Unknown Error"),code:a.error_code}:{success:!0,messageId:a.result.message_id}},async sendAudio(t,e){const s=new FormData;s.append("chat_id",e.chatId),e.caption&&s.append("caption",e.caption),e.threadId&&s.append("message_thread_id",e.threadId.toString());let r=e.audio;if(typeof r=="string"&&r.startsWith("data:"))try{r=await(await fetch(r)).blob()}catch{return{success:!1,error:"Data-URI işlenirken hata oluştu"}}if(r instanceof Blob){const n=this.getExtensionFromBlob(r);s.append("audio",r,`audio.${n}`)}else if(typeof r=="string")s.append("audio",r);else return{success:!1,error:"Invalid audio format"};const i=await fetch(`${this.baseUrl}${t}/sendAudio`,{method:"POST",body:s}),a=await i.json();return!i.ok||!a.ok?{success:!1,error:this.translateError(a.description||"Unknown Error"),code:a.error_code}:{success:!0,messageId:a.result.message_id}},async sendLocation(t,e){if(e.latitude===void 0||e.longitude===void 0)return{success:!1,error:"Coordinates missing"};const s={chat_id:e.chatId,latitude:e.latitude,longitude:e.longitude};return e.threadId&&(s.message_thread_id=e.threadId),this.makeRequest(t,"sendLocation",s)},async getUpdates(t){try{const s=await(await fetch(`${this.baseUrl}${t}/getUpdates?limit=100`)).json();return s.ok?s.result:[]}catch{return[]}},async makeRequest(t,e,s){try{const r=await fetch(`${this.baseUrl}${t}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),i=await r.json();return!r.ok||!i.ok?{success:!1,error:this.translateError(i.description||"API Error"),code:i.error_code}:{success:!0,messageId:i.result.message_id}}catch{return{success:!1,error:"Network Error"}}},translateError(t){const e=t.toLowerCase();return e.includes("chat not found")?"Sohbet bulunamadı. ID yanlış olabilir veya Botu henüz gruba/kanala eklememiş olabilirsiniz.":e.includes("bot is not a member")?"Bot bu grubun/kanalın üyesi değil. Lütfen önce Botu Telegram'dan ekleyin.":e.includes("bot was blocked")?"Bot kullanıcı tarafından engellenmiş. Bot mesaj gönderemez.":e.includes("bot was kicked")?"Bot gruptan atılmış. Tekrar eklemeniz gerekiyor.":e.includes("not enough rights")?"Botun mesaj gönderme yetkisi yok. Lütfen Botun yetkilerini kontrol edin.":e.includes("not an administrator")?"Bot bu kanalda/grupta yönetici değil. Lütfen önce Botu yönetici olarak atayın.":e.includes("forbidden")&&e.includes("admin")?"Erişim Engellendi: Bot yönetici değil veya mesaj gönderme yetkisi kısıtlanmış.":e.includes("thread_id_invalid")||e.includes("thread not found")?"Konu (Topic) bulunamadı. Silinmiş veya ID değişmiş olabilir.":e.includes("initiate conversation")?"Bot kullanıcıyla sohbet başlatamaz. Lütfen önce Telegram'dan bota /start komutunu verin.":e.includes("migrated to a supergroup")?"Grup süpergruba dönüştü. Lütfen grubu silip tekrar ekleyin.":t},async sendPayloadSmart(t,e){if(!e.latitude&&e.text){const s=e.text.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);s&&(e.latitude=parseFloat(s[1]),e.longitude=parseFloat(s[2]))}if(e.latitude!==void 0&&e.longitude!==void 0){const s=await this.sendLocation(t,e);return s.success&&e.text&&!e.text.startsWith("http")&&await this.sendMessage(t,e),s}if(e.document)return this.sendDocument(t,e);if(e.audio)return this.sendAudio(t,e);if(e.photo){const s=typeof e.photo=="string"?e.photo.toLowerCase():"",r=s.endsWith(".svg")||s.includes(".svg?")||s.startsWith("data:image/svg+xml"),i=s.endsWith(".gif")||s.includes(".gif?")||e.photo instanceof Blob&&e.photo.type==="image/gif";return r?this.sendDocument(t,{...e,document:e.photo,photo:void 0}):i?this.sendAnimation(t,{...e,animation:e.photo,photo:void 0}):this.sendPhoto(t,e)}return this.sendMessage(t,e)}};export{c as S,d as T};
